rules_version='2'

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user document and check verification
    function isUserVerified() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isVerified == true;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // Helper function to check if user is not suspended
    // Note: This requires the isSuspended field to exist on the user document.
    // If the field doesn't exist, this will fail. Ensure all user documents have isSuspended set.
    function isNotSuspended() {
      return isAuthenticated() && 
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isSuspended != true);
    }
    
    // Helper function to check if user is verified and not suspended
    function isUserVerifiedAndNotSuspended() {
      return isUserVerified() && isNotSuspended();
    }
    
    // Users collection - users can read their own data, verified users can read others
    match /users/{userId} {
      allow get: if isAuthenticated();
      // Allow list queries for authenticated users (including email queries)
      // This allows queries like: where('email', isEqualTo: '...')
      allow list: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      // Users can update their own document, or admins can update any
      // Also allow updating reputationScore and reportCount fields for other users (calculated/aggregated fields)
      // This allows the rating system to update reputation scores and the reporting system to update report counts
      allow update: if isAuthenticated() && (
        request.auth.uid == userId || 
        isAdmin() ||
        // Allow updating reputationScore for any user (calculated from their ratings)
        // Check that only reputationScore changed and it's a valid number (0-5 range)
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reputationScore']) &&
         request.resource.data.reputationScore is number &&
         request.resource.data.reputationScore >= 0.0 &&
         request.resource.data.reputationScore <= 5.0) ||
        // Allow updating reportCount for any user (incremented when reports are filed)
        // Check that only reportCount and updatedAt changed
        // Note: FieldValue.increment() is a sentinel value, so we can't validate the actual value in rules
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reportCount', 'updatedAt']))
      );
      allow delete: if isAdmin();
    }
    
    // Items collection (for Borrow/Lend)
    match /items/{itemId} {
      allow read: if isAuthenticated();
      allow create: if isUserVerifiedAndNotSuspended();
      allow update: if isUserVerifiedAndNotSuspended();
      allow delete: if isUserVerifiedAndNotSuspended();
    }
    
    // Borrow requests collection
    match /borrow_requests/{requestId} {
      allow read: if isAuthenticated();
      allow create: if isUserVerifiedAndNotSuspended();
      allow update: if isUserVerifiedAndNotSuspended();
      allow delete: if isUserVerifiedAndNotSuspended();
    }
    
    // Rental listings collection
    match /rental_listings/{listingId} {
      allow read: if isAuthenticated();
      allow create: if isUserVerifiedAndNotSuspended();
      allow update: if isUserVerifiedAndNotSuspended();
      allow delete: if isUserVerifiedAndNotSuspended();
    }
    
    // Rental requests collection
    match /rental_requests/{requestId} {
      allow read: if isAuthenticated();
      allow create: if isUserVerifiedAndNotSuspended();
      allow update: if isUserVerifiedAndNotSuspended();
      allow delete: if isUserVerifiedAndNotSuspended();
    }
    
    // Rental payments collection
    match /rental_payments/{paymentId} {
      // Users can read payments for their rental requests (renter or owner)
      allow read: if isAuthenticated() && (
        resource.data.renterId == request.auth.uid ||
        resource.data.ownerId == request.auth.uid
      );
      // Allow list queries for authenticated users (filtered by rentalRequestId in query)
      allow list: if isAuthenticated();
      // Verified users can create payment records
      allow create: if isUserVerifiedAndNotSuspended();
      // Only admins can update or delete payment records
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Rental audits collection (audit trail for rental transactions)
    match /rental_audits/{auditId} {
      // Only admins can read audit records
      allow read: if isAdmin();
      // System/admins can create audit records
      allow create: if isUserVerifiedAndNotSuspended();
      // Only admins can update or delete audit records
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Trade items collection
    match /trade_items/{itemId} {
      allow read: if isAuthenticated();
      allow create: if isUserVerifiedAndNotSuspended();
      allow update: if isUserVerifiedAndNotSuspended();
      allow delete: if isUserVerifiedAndNotSuspended();
    }
    
    // Trade offers collection
    match /trade_offers/{offerId} {
      allow read: if isAuthenticated();
      allow create: if isUserVerifiedAndNotSuspended();
      allow update: if isUserVerifiedAndNotSuspended();
      allow delete: if isUserVerifiedAndNotSuspended();
    }
    
    // Giveaway listings collection (legacy - keeping for backward compatibility)
    match /giveaway_listings/{listingId} {
      allow read: if isAuthenticated();
      allow create: if isUserVerifiedAndNotSuspended();
      allow update: if isUserVerifiedAndNotSuspended();
      allow delete: if isUserVerifiedAndNotSuspended();
    }
    
    // Giveaways collection (active donation listings)
    match /giveaways/{giveawayId} {
      allow read: if isAuthenticated();
      allow create: if isUserVerifiedAndNotSuspended();
      allow update: if isUserVerifiedAndNotSuspended();
      allow delete: if isUserVerifiedAndNotSuspended();
    }
    
    // Giveaway claims collection (claim requests for giveaways)
    match /giveaway_claims/{claimId} {
      // Users can read their own claims or claims for their giveaways
      allow get: if isAuthenticated() && (
        resource.data.claimantId == request.auth.uid ||
        resource.data.donorId == request.auth.uid
      );
      // Allow list queries for authenticated users (filtered by claimantId or donorId in query)
      // This allows queries like: where('donorId', isEqualTo: ...) or where('claimantId', isEqualTo: ...)
      allow list: if isAuthenticated();
      // Verified users can create claims
      allow create: if isUserVerifiedAndNotSuspended();
      // Users can update their own claims or claims for their giveaways
      allow update: if isAuthenticated() && (
        resource.data.claimantId == request.auth.uid ||
        resource.data.donorId == request.auth.uid
      );
      // Users can delete their own claims
      allow delete: if isAuthenticated() && resource.data.claimantId == request.auth.uid;
    }
    
    // Giveaway ratings collection (ratings/reviews for giveaways)
    match /giveaway_ratings/{ratingId} {
      // All authenticated users can read ratings (public reviews)
      allow read: if isAuthenticated();
      // Allow list queries for authenticated users (filtered by donorId, raterId, or giveawayId in query)
      allow list: if isAuthenticated();
      // Authenticated users can create ratings (after claiming/claiming giveaways)
      allow create: if isAuthenticated() && 
                       isNotSuspended() &&
                       request.resource.data.raterId == request.auth.uid;
      // Users can update their own ratings
      allow update: if isAuthenticated() && 
                       isNotSuspended() &&
                       resource.data.raterId == request.auth.uid;
      // Users can delete their own ratings, or admins can delete any
      allow delete: if isAuthenticated() && (
        resource.data.raterId == request.auth.uid || isAdmin()
      );
    }
    
    // Calamity events collection
    match /calamity_events/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Calamity donations collection
    match /calamity_donations/{donationId} {
      allow read: if isAuthenticated();
      allow create: if isUserVerifiedAndNotSuspended();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      // Users can read their own notifications (where toUserId matches)
      allow get: if isAuthenticated() && resource.data.toUserId == request.auth.uid;
      // Allow list queries for authenticated users (filtered by toUserId in query)
      allow list: if isAuthenticated();
      // Authenticated users can create notifications (system creates for users)
      allow create: if isAuthenticated();
      // Users can update their own notifications (mark as read)
      allow update: if isAuthenticated() && resource.data.toUserId == request.auth.uid;
      // Users can delete their own notifications
      allow delete: if isAuthenticated() && resource.data.toUserId == request.auth.uid;
    }
    
    // Chats and messages - allow authenticated users (but not suspended)
    match /chats/{chatId} {
      allow read: if isAuthenticated();
      allow write: if isNotSuspended();
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow write: if isNotSuspended();
      }
    }
    
    // Conversations and messages - allow authenticated users (but not suspended)
    match /conversations/{conversationId} {
      allow read: if isAuthenticated();
      allow write: if isNotSuspended();
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow write: if isNotSuspended();
      }
    }
    
    // Email verifications - allow authenticated users to manage their own
    match /email_verifications/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Analytics collection - admins only
    match /analytics/{documentId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // Reports collection - authenticated users can read, admins can write
    match /reports/{reportId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isNotSuspended();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Feedback collection - users can submit feedback, admins can read/manage
    match /feedback/{feedbackId} {
      // Users can read their own feedback
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Admins can read all feedback
      allow read: if isAdmin();
      // Authenticated users can create feedback
      allow create: if isAuthenticated() && isNotSuspended();
      // Only admins can update or delete feedback
      allow update, delete: if isAdmin();
    }
    
    // Ratings collection (user reviews and ratings)
    match /ratings/{ratingId} {
      // All authenticated users can read ratings (public reviews)
      allow read: if isAuthenticated();
      // Allow list queries for authenticated users
      allow list: if isAuthenticated();
      // Authenticated users can create ratings (after completing transactions)
      allow create: if isAuthenticated() && 
                       isNotSuspended() &&
                       request.resource.data.raterUserId == request.auth.uid;
      // Users can update their own ratings
      allow update: if isAuthenticated() && 
                       isNotSuspended() &&
                       resource.data.raterUserId == request.auth.uid;
      // Users can delete their own ratings, or admins can delete any
      allow delete: if isAuthenticated() && (
        resource.data.raterUserId == request.auth.uid || isAdmin()
      );
    }
    
    // Reminders collection (scheduled reminders for rentals, borrows, etc.)
    match /reminders/{reminderId} {
      // Users can read their own reminders
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Allow list queries for authenticated users (filtered by userId, itemId, or rentalRequestId in query)
      allow list: if isAuthenticated();
      // Authenticated users can create reminders (system creates reminders for users)
      // Note: Reminders can be created for other users (e.g., lender creates reminder for borrower)
      allow create: if isAuthenticated();
      // Users can update reminders if authenticated
      // For system-managed reminders (rental/borrow overdue, etc.), allow update by any authenticated user
      // (since reminders are system-managed and both parties may need to update them)
      // Note: We allow update of overdue reminders without checking suspension to avoid issues
      allow update: if isAuthenticated() && (
        // User owns the reminder (check suspension for owned reminders)
        (isNotSuspended() && resource.data.userId == request.auth.uid) ||
        // Allow update of rental-related reminders (has rentalRequestId) or rental overdue type
        resource.data.rentalRequestId != null ||
        resource.data.reminderType == 'rental_overdue' ||
        // Allow update of borrow-related overdue reminders
        resource.data.reminderType == 'overdue' ||
        isAdmin()
      );
      // Users can delete their own reminders, or system can delete (for item/rental cancellation)
      // For system-managed reminders, allow deletion by any authenticated user
      // (since both parties need to clean up reminders when transactions are cancelled)
      // Note: We allow deletion of overdue reminders without checking suspension to avoid
      // issues when user documents might not be accessible
      allow delete: if isAuthenticated() && (
        // User owns the reminder
        resource.data.userId == request.auth.uid || 
        // Admin can delete any reminder
        isAdmin() ||
        // Allow deletion of any rental-related reminder (check document ID pattern)
        reminderId.matches('rental_.*_overdue_.*') ||
        // Allow deletion of rental overdue reminders
        resource.data.reminderType == 'rental_overdue' ||
        // Allow deletion of borrow overdue reminders  
        resource.data.reminderType == 'overdue' ||
        // Allow deletion if it has rentalRequestId (rental-related reminder)
        resource.data.rentalRequestId != null ||
        // TEMPORARY: Allow deletion of any reminder with itemId (for debugging)
        // TODO: Remove this after confirming the issue is resolved
        resource.data.itemId != null
      );
    }
    
    // Activity Logs collection (admin monitoring and audit trail)
    match /activity_logs/{logId} {
      // Only admins can read activity logs
      allow read: if isAdmin();
    // Allow any authenticated user (including newly registered ones) to create logs.
    // This avoids registration-time permission issues while keeping logs append-only.
    allow create: if isAuthenticated();
      // Only admins can update or delete logs
      allow update, delete: if isAdmin();
    }
    
    // FCM tokens collection (for push notifications)
    // NOTE: We intentionally do NOT use isNotSuspended() here.
    // - On first login, the users/{uid} document might not exist yet,
    //   which makes isNotSuspended() fail and blocks token saves.
    // - FCM tokens are lowâ€‘risk metadata; we still restrict by uid.
    match /fcm_tokens/{userId} {
      // Users can read their own FCM token
      allow get: if isAuthenticated() && request.auth.uid == userId;
      // Allow list queries for authenticated users (filtered by userId in query)
      allow list: if isAuthenticated();
      // Users can create/update their own FCM token (document ID must match their userId)
      allow create, update: if isAuthenticated() &&
                               request.auth.uid == userId;
      // Users can delete their own FCM token
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Trade disputes collection
    match /trade_disputes/{disputeId} {
      // TEMP: allow any authenticated user to create/read trade disputes.
      // We still store openedByUserId/otherUserId in documents for future tightening.
      allow create: if isAuthenticated() && isNotSuspended();
      allow get, list: if isAuthenticated();
      allow update: if isAuthenticated() && isNotSuspended();
      allow delete: if isAdmin();
    }
    
    // Default: deny all other collections unless explicitly allowed
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
